<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Data Extractor</title>
    <script src="build/react.js"></script>
    <script src="build/react-dom.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <link rel="stylesheet" href="mystyle.css">
    <style type="text/css">
      .append-box{
        font-size: 12px;
        font-family: sans-serif;
        height: auto;
        border: 1px solid black;
        padding: 10px;
        text-decoration: none;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="text/babel">

    var mountNode = document.getElementById('example')
    var global_id=0;
    var runJson=[];
    var UrlBox = React.createClass({
      getInitialState: function() {
        return {url: ""};
      },
      handleChange: function(event) {
        this.setState({ url: event.target.value });
      },
      submitUrl: function(e){
       e.preventDefault();
       this.props.load(this.state.url);
       this.setState({ url:"" })
      },
      render: function() {
        return (
          <form id="myform" className="well clearfix">
            <div className="col-lg-7 col-sm-7">
              <input className="form-control" onChange={this.handleChange} value={this.state.url}/>
            </div>
            <button className="btn btn-primary pull-left" disabled={this.state.url.length === 0} onClick={this.submitUrl}>Load Url</button>
          </form>
        );
      }
    });

    var AppendItem = React.createClass({
      render: function() {
        return(
          <div>
            <form role = "form" >
                <div className="row" style={{padding:5}}>
                    <label className="col-lg-4 pull-left">CSS Field</label>
                    <input className="col-lg-6 pull-left" type="text" name="css-input" id="css-input"  value={this.props.input.css} />
                </div>
                <div className="row" style={{padding:5}}>
                    <label className="col-lg-4 pull-left">Attribute Field</label>
                    <input className="col-lg-6 pull-left" type="text" name="attr-input" id="attr-input"  value={this.props.input.attr} />
                </div>
            </form>
          </div>
        );
      }
    });

    var LeftPanel = React.createClass({
      getInitialState: function() {
        return {
          element: [],
          obj: [],
          jsonData: []
        };
      },
      addDivision: function(){
        var element = <AppendItem input={this.props.input}/>
        this.setState({ obj:this.props.input })
        var preState = this.state.element
        var newState = preState.concat(element);
        this.setState({  element: newState });

        if(this.state.element.length>0){
          this.state.jsonData.push(this.state.obj)
        }
      },
      processQuery: function(){
        console.log("processing query . . .1");
        this.state.jsonData.push(this.state.obj)
        this.props.parseData(this.state.jsonData);
        this.setState({ jsonData:[] })
      },
      clearQuery: function(){
        this.setState({element: []});
      },
      deleteElement: function(a) {
        this.state.element.splice(a, 1);
        this.setState({element: this.state.element});
      },
      render: function(){
        var _this=this;
        global_id=this.state.element.length;
        var createDivision = function(item,i) {
          return(
            <div id={"append"+i} className="append-box">
                <div id='close' style={{float: 'right',color:'red'}} onClick={_this.deleteElement.bind(null, i)} >close</div>
                {item}
            </div>
          );
        };
        return(
          <div>
            <button className="btn btn-default" onClick={this.addDivision} style={{margin:10}}> + </button>
            <button className="btn btn-primary" onClick={this.processQuery} style={{margin:10}}> Execute </button>
            <button className="btn btn-primary" onClick={this.clearQuery} style={{margin:10}}> Clear </button>
            {this.state.element.map(createDivision)}
          </div>
        );

      }
    });

    var Iframe = React.createClass({
        onFrameLoaded: function(frame){
          var that = this;
          $(frame).contents().click(function(e){
            var output={}
            var cssSelector=$(e.target).getPath();
            var uniqueCssSelector=cssSelector.replace(/>/g," ");
            // alert(uniqueCssSelector);
            var idAry=e.target.getAttribute("id");
            var classAry=e.target.getAttribute("class");
            var str="";
            var flag=false
            if(idAry != null ){
              str+=idAry.toString();
              flag=true;
            }
            if(classAry != null ){
              if(flag)
                str+=","
              str+=classAry.toString();
            }
            output = {
              "css" : uniqueCssSelector,
              "attr": str
            }
            that.props.onSelect(output);
          });
        },
        render: function() {
          return (
            <iframe ref={this.onFrameLoaded} className="col col-lg-12" height="700px" allowfullscreen="" id="myIframe" sandbox="allow-same-origin allow-scripts"></iframe>
          );
        }
    });

    var ResultBox = React.createClass({
      getInitialState: function(){
        return {
          resultJson: []
        };
      },
      render: function() {
        var createDivision = function(item,i) {
          return(
            <div>
            <h4>
              <div className="badge" style={{padding:10}}>Result :{i+1}</div>
              <div className="label label-info" style={{padding:10}} >  {item.val} </div>
            </h4>
            </div>
          );
        };
        return (
          <div>
            <h2>
              <label className="label label-success">Result : </label>
            </h2>
            <div className="row panel panel-heading" id="result">
              {this.props.result.map(createDivision)}
            </div>
          </div>
        );
      }
    });

    var App = React.createClass({
      getInitialState : function(){
        return {
          url:"",
          obj: [],
          jsonInput: [],
          jsonOutput: []
        };
      },
      onSelect: function(input) {
        this.setState({ obj:input });
      },
      executeQuery: function(data){
        this.state.jsonInput=data;
        var _this=this
        $.post("/getresult",{data: JSON.stringify(this.state.jsonInput)},function(data, status){
          _this.setState({ jsonOutput:data });
          console.log(_this.state.jsonOutput);
        });
      },
      loadUrl : function(submittedUrl){
        this.state.url=submittedUrl;
        this.setState({ jsonInput:[] })
        this.setState({ jsonOutput:[] })
        // alert(this.state.jsonInput.length)
        $.post("/loadwebpage",{"url":this.state.url},function(data, status){
          $('#myIframe').contents().find('body').html(data);
        });
      },
      render : function(){
         return(
           <div>
            <div className="row">
              <UrlBox load={this.loadUrl} val={this.state.url}/>
            </div>
            <div className="row" style={{padding:25}}>
              <div  className="col col-lg-7" >
                <div className="row">
                  <Iframe url={this.state.url} onSelect={this.onSelect}/>
                </div>
                <div className="row">
                  <ResultBox result={this.state.jsonOutput}/>
                </div>
              </div>
              <div className="col col-lg-4">
                <LeftPanel  parseData={this.executeQuery} input={this.state.obj} />
              </div>
            </div>
           </div>
         );
       }
    });

    ReactDOM.render(<App />,document.getElementById("container"));
    jQuery.fn.extend({
        getPath: function () {
            var path, node = this;
            console.log("getPath");
            while (node.length) {
                var realNode = node[0], name = realNode.localName;
                if (!name) break;
                name = name.toLowerCase();

                var parent = node.parent();

                var sameTagSiblings = parent.children(name);
                if (sameTagSiblings.length > 1) {
                    var allSiblings = parent.children();
                    var index = allSiblings.index(realNode) + 1;
                    if (index > 1) {
                        name += ':nth-child(' + index + ')';
                    }
                }

                path = name + (path ? '>' + path : '');
                node = parent;
            }
            // debugger
            return path;
        }
    });
    </script>
  </body>

</html>
